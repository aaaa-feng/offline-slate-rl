# SAC+GeMS RL è®­ç»ƒå‚æ•°å…¨é¢åˆ†æ

## å‚æ•°æ¥æºå¯¹æ¯”

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº† SAC+GeMS RL è®­ç»ƒçš„æ‰€æœ‰å‚æ•°ï¼Œå¯¹æ¯”äº†ä»¥ä¸‹æ¥æºï¼š
1. **README ç¬¬86è¡Œå‘½ä»¤** (åŸç‰ˆè®ºæ–‡ README)
2. **config/train_SAC+GeMS.yml** (é…ç½®æ–‡ä»¶)
3. **EXPERIMENT_GUIDE.md** (å®éªŒæŒ‡å—)

---

## ğŸ” å‚æ•°å†²çªåˆ†æ

### å…³é”®å‘ç°ï¼šREADME å‘½ä»¤ä¸­çš„å‚æ•°ä¸é¢„è®­ç»ƒä¸ä¸€è‡´ï¼

**README ç¬¬86è¡Œå‘½ä»¤ä¸­çš„ GeMS å‚æ•°**ï¼š
- `--lambda_KL=0.5`
- `--lambda_click=0.2`

**ä½†æ˜¯é¢„è®­ç»ƒæ—¶ä½¿ç”¨çš„å‚æ•°**ï¼š
- å‚æ•°å¥—1: `lambda_KL=0.5, lambda_click=0.2` âœ… ä¸ README ä¸€è‡´
- å‚æ•°å¥—2: `lambda_KL=1.0, lambda_click=0.5` âŒ ä¸ README ä¸ä¸€è‡´

**README ç¬¬100-102è¡Œè¡¨æ ¼**ï¼š
- beta (lambda_KL) = 1.0
- lambda (lambda_click) = 0.5

**ç»“è®º**ï¼šREADME å‘½ä»¤ç¤ºä¾‹ä¸ README è¡¨æ ¼å­˜åœ¨å†²çªï¼

---

## ğŸ“‹ å®Œæ•´å‚æ•°åˆ—è¡¨

### 1. å¿…éœ€å‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--agent` | SAC | SAC | Agentç±»å‹ | âœ… æ—  |
| `--belief` | GRU | GRU | Belief encoder | âœ… æ—  |
| `--ranker` | GeMS | GeMS | Rankerç±»å‹ | âœ… æ—  |
| `--item_embedds` | scratch | scratch | Item embeddings | âœ… æ—  |
| `--env_name` | topics | topics | ç¯å¢ƒåç§° | âœ… æ—  |

### 2. SAC Agent å‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--q_lr` | 0.001 | 0.001 | Qç½‘ç»œå­¦ä¹ ç‡ | âœ… æ—  |
| `--pi_lr` | 0.003 | 0.003 | ç­–ç•¥ç½‘ç»œå­¦ä¹ ç‡ | âœ… æ—  |
| `--hidden_layers_qnet` | 256 | 256 | Qç½‘ç»œéšè—å±‚ | âœ… æ—  |
| `--hidden_layers_pinet` | 256 | 256 | ç­–ç•¥ç½‘ç»œéšè—å±‚ | âœ… æ—  |
| `--target_update_frequency` | 1 | 1 | ç›®æ ‡ç½‘ç»œæ›´æ–°é¢‘ç‡ | âœ… æ—  |
| `--tau` | 0.002 | 0.002 | è½¯æ›´æ–°ç³»æ•° | âœ… æ—  |
| `--gamma` | 0.8 | 0.8 | æŠ˜æ‰£å› å­ | âœ… æ—  |
| `--auto_entropy` | True | True | è‡ªåŠ¨è°ƒæ•´ç†µç³»æ•° | âœ… æ—  |
| `--alpha` | 0.2 | 0.2 | ç†µç³»æ•°ï¼ˆåˆå§‹å€¼ï¼‰ | âœ… æ—  |

### 3. GeMS Ranker å‚æ•° âš ï¸ **æœ‰äº‰è®®**
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | READMEè¡¨æ ¼ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|-----------|------|------|
| `--latent_dim` | 32 | 32 | 32 (d) | æ½œåœ¨ç©ºé—´ç»´åº¦ | âœ… æ—  |
| `--lambda_KL` | **0.5** | **å¾…æŸ¥** | **1.0** (beta) | KLæ•£åº¦æƒé‡ | âš ï¸ **æœ‰å†²çª** |
| `--lambda_click` | **0.2** | **å¾…æŸ¥** | **0.5** (lambda) | ç‚¹å‡»æŸå¤±æƒé‡ | âš ï¸ **æœ‰å†²çª** |
| `--lambda_prior` | 0.0 | 0.0 | - | å…ˆéªŒæŸå¤±æƒé‡ | âœ… æ—  |
| `--ranker_embedds` | scratch | scratch | - | Ranker embeddings | âœ… æ—  |
| `--ranker_sample` | False | False | - | æ˜¯å¦é‡‡æ · | âœ… æ—  |
| `--ranker_dataset` | focused_topdown_moving_env | å¾…æŸ¥ | - | Rankeræ•°æ®é›†å | âš ï¸ éœ€ç¡®è®¤ |
| `--ranker_seed` | 58407201 | å¾…æŸ¥ | - | Rankeré¢„è®­ç»ƒç§å­ | âœ… æ—  |

### 4. Replay Buffer å‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--capacity` | 10000 | 10000 | ç¼“å†²åŒºå®¹é‡ | âœ… æ—  |
| `--batch_size` | 20 | 20 | æ‰¹æ¬¡å¤§å° | âœ… æ—  |
| `--random_steps` | 2000 | 2000 | éšæœºæ¢ç´¢æ­¥æ•° | âœ… æ—  |

### 5. Belief Encoder å‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--belief_state_dim` | 20 | 20 | BeliefçŠ¶æ€ç»´åº¦ | âœ… æ—  |
| `--item_embedd_dim` | 20 | 20 | Item embeddingç»´åº¦ | âœ… æ—  |

### 6. è®­ç»ƒå‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--max_steps` | 100000 | 100000 | æœ€å¤§è®­ç»ƒæ­¥æ•° | âœ… æ—  |
| `--check_val_every_n_epoch` | 1000 | 1000 | éªŒè¯é¢‘ç‡ | âœ… æ—  |
| `--val_step_length` | 200 | 200 | éªŒè¯episodeé•¿åº¦ | âœ… æ—  |
| `--test_size` | 500 | 500 | æµ‹è¯•episodeæ•°é‡ | âœ… æ—  |
| `--seed` | 58407201 | å¾…æŸ¥ | éšæœºç§å­ | âœ… æ—  |
| `--name` | SAC+GeMS | SAC+GeMS | å®éªŒåç§° | âœ… æ—  |

### 7. ç¯å¢ƒå‚æ•° (TopicRec)
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--num_items` | 1000 | 1000 | ç‰©å“æ€»æ•° | âœ… æ—  |
| `--boredom_threshold` | 5 | 5 | åŒå€¦é˜ˆå€¼ | âœ… æ—  |
| `--recent_items_maxlen` | 10 | 10 | æœ€è¿‘ç‰©å“æœ€å¤§é•¿åº¦ | âœ… æ—  |
| `--boredom_moving_window` | 5 | 5 | åŒå€¦æ»‘åŠ¨çª—å£ | âœ… æ—  |
| `--env_omega` | 0.9 | 0.9 | ç¯å¢ƒomegaå‚æ•° | âœ… æ—  |
| `--short_term_boost` | 1.0 | 1.0 | çŸ­æœŸå¥–åŠ±æå‡ | âœ… æ—  |
| `--episode_length` | 100 | 100 | Episodeé•¿åº¦ | âœ… æ—  |
| `--env_offset` | 0.28 | 0.28 | ç¯å¢ƒåç§» | âœ… æ—  |
| `--env_slope` | 100 | 100 | ç¯å¢ƒæ–œç‡ | âœ… æ—  |
| `--diversity_threshold` | 4 | 4 | å¤šæ ·æ€§é˜ˆå€¼ | âœ… æ—  |
| `--topic_size` | 2 | 2 | ä¸»é¢˜å¤§å° | âœ… æ—  |
| `--num_topics` | 10 | 10 | ä¸»é¢˜æ•°é‡ | âœ… æ—  |
| `--diversity_penalty` | 1.0 | 1.0 | å¤šæ ·æ€§æƒ©ç½š | âœ… æ—  |
| `--click_model` | tdPBM | å¾…æŸ¥ | ç‚¹å‡»æ¨¡å‹ | âš ï¸ éœ€ç¡®è®¤ |
| `--env_embedds` | item_embeddings_focused.pt | å¾…æŸ¥ | ç¯å¢ƒembeddings | âš ï¸ éœ€ç¡®è®¤ |

### 8. å…¶ä»–å‚æ•°
| å‚æ•° | READMEå‘½ä»¤ | Configæ–‡ä»¶ | è¯´æ˜ | äº‰è®® |
|------|-----------|-----------|------|------|
| `--device` | cuda | cuda | è®¾å¤‡ | âœ… æ—  |
| `--beliefs` | actor critic | å¾…æŸ¥ | Beliefç±»å‹åˆ—è¡¨ | âš ï¸ éœ€ç¡®è®¤ |

---

## âš ï¸ å…³é”®äº‰è®®å‚æ•°

### 1. **lambda_KL å’Œ lambda_click** - æœ€é‡è¦çš„äº‰è®®

**é—®é¢˜**ï¼šREADME å‘½ä»¤ç¤ºä¾‹ä¸ README è¡¨æ ¼ä¸ä¸€è‡´

**README ç¬¬86è¡Œå‘½ä»¤**ï¼š
```bash
--lambda_KL=0.5 --lambda_click=0.2
```

**README ç¬¬100-102è¡Œè¡¨æ ¼**ï¼š
```
beta (lambda_KL) = 1.0
lambda (lambda_click) = 0.5
```

**æˆ‘ä»¬çš„é¢„è®­ç»ƒç»“æœ**ï¼š
- å‚æ•°å¥—1 (KL=0.5, click=0.2): Loss 1.87-2.10 âœ… æ›´ä½
- å‚æ•°å¥—2 (KL=1.0, click=0.5): Loss 2.61-2.79

**å»ºè®®**ï¼š
- **æ–¹æ¡ˆA**: ä½¿ç”¨ README å‘½ä»¤çš„å‚æ•° (0.5, 0.2) - ä¸å‚æ•°å¥—1ä¸€è‡´ï¼Œlossæ›´ä½
- **æ–¹æ¡ˆB**: ä½¿ç”¨ README è¡¨æ ¼çš„å‚æ•° (1.0, 0.5) - ä¸å‚æ•°å¥—2ä¸€è‡´ï¼Œè®ºæ–‡å®˜æ–¹å€¼
- **æ–¹æ¡ˆC**: ä¸¤å¥—éƒ½è·‘ï¼Œå¯¹æ¯”æ•ˆæœ

### 2. **ranker_dataset** - æ•°æ®é›†åç§°

**README å‘½ä»¤**ï¼š
```bash
--ranker_dataset="focused_topdown_moving_env"
```

**å®é™…æ–‡ä»¶å**ï¼š
```
focused_topdown.pt  (æ²¡æœ‰ _moving_env åç¼€)
```

**éœ€è¦ä¿®æ­£ä¸º**ï¼š
```bash
--ranker_dataset="focused_topdown"
```

### 3. **click_model** - ä¸åŒç¯å¢ƒçš„ç‚¹å‡»æ¨¡å‹

**focused ç¯å¢ƒçš„ç‚¹å‡»æ¨¡å‹**ï¼š
- focused_topdown: `tdPBM`
- focused_mix: `mixPBM`
- focused_divpen: `mixPBM`

---

## ğŸ“Š å‚æ•°å«ä¹‰è¯¦è§£

### SAC Agent å‚æ•°
- **q_lr (0.001)**: Qç½‘ç»œï¼ˆä»·å€¼å‡½æ•°ï¼‰çš„å­¦ä¹ ç‡
- **pi_lr (0.003)**: ç­–ç•¥ç½‘ç»œçš„å­¦ä¹ ç‡ï¼Œé€šå¸¸æ¯”Qç½‘ç»œé«˜
- **hidden_layers_qnet (256)**: Qç½‘ç»œéšè—å±‚ç¥ç»å…ƒæ•°é‡
- **hidden_layers_pinet (256)**: ç­–ç•¥ç½‘ç»œéšè—å±‚ç¥ç»å…ƒæ•°é‡
- **target_update_frequency (1)**: æ¯1æ­¥æ›´æ–°ä¸€æ¬¡ç›®æ ‡ç½‘ç»œ
- **tau (0.002)**: è½¯æ›´æ–°ç³»æ•°ï¼Œæ§åˆ¶ç›®æ ‡ç½‘ç»œæ›´æ–°é€Ÿåº¦
- **gamma (0.8)**: æŠ˜æ‰£å› å­ï¼Œè¾ƒä½å€¼æ›´å…³æ³¨çŸ­æœŸå¥–åŠ±
- **auto_entropy (True)**: è‡ªåŠ¨è°ƒæ•´ç†µç³»æ•°ï¼Œå¹³è¡¡æ¢ç´¢ä¸åˆ©ç”¨
- **alpha (0.2)**: ç†µç³»æ•°åˆå§‹å€¼

### GeMS Ranker å‚æ•°
- **latent_dim (32)**: VAEæ½œåœ¨ç©ºé—´ç»´åº¦
- **lambda_KL**: KLæ•£åº¦æŸå¤±æƒé‡ï¼Œæ§åˆ¶æ½œåœ¨ç©ºé—´çš„æ­£åˆ™åŒ–
- **lambda_click**: ç‚¹å‡»é¢„æµ‹æŸå¤±æƒé‡
- **lambda_prior (0.0)**: å…ˆéªŒæŸå¤±æƒé‡
- **ranker_embedds (scratch)**: ä»å¤´è®­ç»ƒembeddings
- **ranker_sample (False)**: æ¨ç†æ—¶ä¸é‡‡æ ·ï¼Œä½¿ç”¨å‡å€¼
- **ranker_dataset**: ç”¨äºåŠ è½½é¢„è®­ç»ƒGeMSæ¨¡å‹çš„æ•°æ®é›†å
- **ranker_seed**: é¢„è®­ç»ƒGeMSæ—¶ä½¿ç”¨çš„éšæœºç§å­

### Replay Buffer å‚æ•°
- **capacity (10000)**: ç»éªŒå›æ”¾ç¼“å†²åŒºå®¹é‡
- **batch_size (20)**: æ¯æ¬¡è®­ç»ƒé‡‡æ ·çš„æ‰¹æ¬¡å¤§å°
- **random_steps (2000)**: å¼€å§‹è®­ç»ƒå‰çš„éšæœºæ¢ç´¢æ­¥æ•°

### è®­ç»ƒå‚æ•°
- **max_steps (100000)**: æœ€å¤§è®­ç»ƒæ­¥æ•°
- **check_val_every_n_epoch (1000)**: æ¯1000ä¸ªepochéªŒè¯ä¸€æ¬¡
- **val_step_length (200)**: éªŒè¯æ—¶è¿è¡Œ200æ­¥
- **test_size (500)**: æµ‹è¯•æ—¶è¿è¡Œ500ä¸ªepisode

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### é’ˆå¯¹ä¸¤å¥—é¢„è®­ç»ƒå‚æ•°çš„ RL è®­ç»ƒç­–ç•¥

ç”±äºæˆ‘ä»¬é¢„è®­ç»ƒäº†ä¸¤å¥—å‚æ•°çš„ GeMS æ¨¡å‹ï¼Œå»ºè®®ï¼š

**å®éªŒç»„1ï¼šä½¿ç”¨å‚æ•°å¥—1çš„GeMSæ¨¡å‹**
```bash
--lambda_KL=0.5 --lambda_click=0.2
--ranker_seed=58407201
```
- ä¼˜ç‚¹ï¼šé¢„è®­ç»ƒlossæ›´ä½ (1.87-2.10)
- ä¸ README å‘½ä»¤ç¤ºä¾‹ä¸€è‡´

**å®éªŒç»„2ï¼šä½¿ç”¨å‚æ•°å¥—2çš„GeMSæ¨¡å‹**
```bash
--lambda_KL=1.0 --lambda_click=0.5
--ranker_seed=58407201
```
- ä¼˜ç‚¹ï¼šä¸ README è¡¨æ ¼ä¸€è‡´ï¼Œè®ºæ–‡å®˜æ–¹å‚æ•°
- é¢„è®­ç»ƒlossè¾ƒé«˜ (2.61-2.79)

### ç¯å¢ƒç‰¹å®šå‚æ•°

**focused_topdown**:
```bash
--ranker_dataset="focused_topdown"
--click_model="tdPBM"
--env_embedds="item_embeddings_focused.pt"
```

**focused_mix**:
```bash
--ranker_dataset="focused_mix"
--click_model="mixPBM"
--env_embedds="item_embeddings_focused.pt"
```

**focused_divpen**:
```bash
--ranker_dataset="focused_divpen"
--click_model="mixPBM"
--diversity_penalty=3.0
--env_embedds="item_embeddings_focused.pt"
```

---

## æ€»ç»“

1. âœ… **å¤§éƒ¨åˆ†å‚æ•°æ— äº‰è®®**ï¼šSACã€Bufferã€Beliefã€ç¯å¢ƒå‚æ•°éƒ½ä¸€è‡´
2. âš ï¸ **å…³é”®äº‰è®®**ï¼šlambda_KL å’Œ lambda_click å­˜åœ¨å†²çª
3. âš ï¸ **éœ€è¦ä¿®æ­£**ï¼šranker_dataset æ–‡ä»¶åï¼ˆå»æ‰ _moving_env åç¼€ï¼‰
4. ğŸ“Š **å»ºè®®**ï¼šä¸¤å¥—å‚æ•°éƒ½è·‘ï¼Œå¯¹æ¯” RL è®­ç»ƒæ•ˆæœ

