# æ¨¡å‹ç®¡ç†å’Œæ•°æ®æ”¶é›†è·¯å¾„è§„åˆ’

## ğŸ“ å½“å‰è·¯å¾„ç»“æ„

### 1. è®­ç»ƒæ¨¡å‹ä¿å­˜ä½ç½®ï¼ˆæ—§é¡¹ç›®ï¼‰
```
/data/liyuefeng/gems/gems_official/official_code/data/checkpoints/
â”œâ”€â”€ diffuse_divpen/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (3.5M)
â”œâ”€â”€ diffuse_mix/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (3.5M)
â”œâ”€â”€ diffuse_topdown/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (3.5M)
â”œâ”€â”€ focused_divpen/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+WkNN_seed58407201_gamma0.8.ckpt (3.9M)
â”œâ”€â”€ focused_mix/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+WkNN_seed58407201_gamma0.8.ckpt (3.9M)
â”œâ”€â”€ focused_topdown/
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta0.5_..._gamma0.8.ckpt (3.5M)
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8.ckpt (2.6M)
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8-v1.ckpt (2.6M)
â”‚   â”œâ”€â”€ SAC+GeMS_..._beta1.0_..._gamma0.8-v2.ckpt (3.5M)
â”‚   â””â”€â”€ SAC+WkNN_seed58407201_gamma0.8.ckpt (3.9M)
â””â”€â”€ default/
    â”œâ”€â”€ REINFORCE+SoftMax_seed58407201_gamma0.8.ckpt (3.4M)
    â”œâ”€â”€ SlateQ_seed58407201_gamma0.8.ckpt (2.2M)
    â”œâ”€â”€ SlateQ_seed58407201_gamma0.8-v1.ckpt (4.5M)
    â””â”€â”€ SlateQ_seed58407201_gamma0.8-v2.ckpt (4.5M)
```

### 2. æ•°æ®æ”¶é›†ä½¿ç”¨çš„æ¨¡å‹ä½ç½®ï¼ˆæ–°é¡¹ç›®ï¼‰
```
/data/liyuefeng/offline-slate-rl/src/data_collection/offline_data_collection/models/sac_gems_models/
â”œâ”€â”€ diffuse_divpen/
â”‚   â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
â”œâ”€â”€ diffuse_mix/
â”‚   â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
â”œâ”€â”€ diffuse_topdown/
â”‚   â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
â”œâ”€â”€ focused_divpen/
â”‚   â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
â”œâ”€â”€ focused_mix/
â”‚   â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
â””â”€â”€ focused_topdown/
    â””â”€â”€ SAC_GeMS_..._beta1.0_..._gamma0.8.ckpt (å·²å¤åˆ¶ï¼Œç”¨äºæ”¶é›†expertæ•°æ®)
```

## ğŸ¯ æ–°çš„æ¨¡å‹ç®¡ç†æ–¹æ¡ˆ

### æ–¹æ¡ˆè®¾è®¡åŸåˆ™
1. **é›†ä¸­ç®¡ç†**: æ‰€æœ‰æ¨¡å‹ç»Ÿä¸€å­˜æ”¾åœ¨æ–°é¡¹ç›®çš„checkpointsç›®å½•
2. **æŒ‰è´¨é‡åˆ†ç±»**: expert (100kæ­¥) / medium (50kæ­¥) / random
3. **æŒ‰agentåˆ†ç±»**: SAC+GeMS / SAC+WkNN / SlateQ / REINFORCE
4. **æ˜“äºæ‰©å±•**: æ”¯æŒæœªæ¥æ·»åŠ æ–°çš„è®­ç»ƒæ­¥æ•°æˆ–agent

### æ¨èçš„æ–°è·¯å¾„ç»“æ„
```
/data/liyuefeng/offline-slate-rl/checkpoints/
â”œâ”€â”€ expert/                          # Expertçº§åˆ«æ¨¡å‹ (100kæ­¥è®­ç»ƒå®Œæˆ)
â”‚   â”œâ”€â”€ sac_gems/
â”‚   â”‚   â”œâ”€â”€ diffuse_divpen/
â”‚   â”‚   â”‚   â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”‚   â”œâ”€â”€ diffuse_mix/
â”‚   â”‚   â”‚   â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”‚   â”œâ”€â”€ diffuse_topdown/
â”‚   â”‚   â”‚   â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”‚   â”œâ”€â”€ focused_divpen/
â”‚   â”‚   â”‚   â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”‚   â”œâ”€â”€ focused_mix/
â”‚   â”‚   â”‚   â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”‚   â””â”€â”€ focused_topdown/
â”‚   â”‚       â”œâ”€â”€ beta0.5_click0.2.ckpt
â”‚   â”‚       â””â”€â”€ beta1.0_click0.5.ckpt
â”‚   â”œâ”€â”€ sac_wknn/
â”‚   â”‚   â”œâ”€â”€ focused_divpen/
â”‚   â”‚   â”‚   â””â”€â”€ model.ckpt
â”‚   â”‚   â”œâ”€â”€ focused_mix/
â”‚   â”‚   â”‚   â””â”€â”€ model.ckpt
â”‚   â”‚   â””â”€â”€ focused_topdown/
â”‚   â”‚       â””â”€â”€ model.ckpt
â”‚   â”œâ”€â”€ slateq/
â”‚   â”‚   â”œâ”€â”€ focused_divpen/
â”‚   â”‚   â”‚   â””â”€â”€ model.ckpt
â”‚   â”‚   â”œâ”€â”€ focused_mix/
â”‚   â”‚   â”‚   â””â”€â”€ model.ckpt
â”‚   â”‚   â””â”€â”€ focused_topdown/
â”‚   â”‚       â””â”€â”€ model.ckpt
â”‚   â””â”€â”€ reinforce/
â”‚       â””â”€â”€ default/
â”‚           â””â”€â”€ model.ckpt
â”‚
â”œâ”€â”€ medium/                          # Mediumçº§åˆ«æ¨¡å‹ (50kæ­¥è®­ç»ƒ)
â”‚   â”œâ”€â”€ sac_gems/
â”‚   â”‚   â”œâ”€â”€ diffuse_divpen/
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â”‚   â”œâ”€â”€ diffuse_mix/
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â”‚   â”œâ”€â”€ diffuse_topdown/
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â”‚   â”œâ”€â”€ focused_divpen/
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â”‚   â”œâ”€â”€ focused_mix/
â”‚   â”‚   â”‚   â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â”‚   â””â”€â”€ focused_topdown/
â”‚   â”‚       â””â”€â”€ beta1.0_click0.5_step50k.ckpt  (å¾…è®­ç»ƒ)
â”‚   â””â”€â”€ [å…¶ä»–agentçš„mediumæ¨¡å‹...]
â”‚
â””â”€â”€ random/                          # Randomç­–ç•¥æ¨¡å‹
    â””â”€â”€ [å¦‚æœéœ€è¦çš„è¯]
```

### æ•°æ®æ”¶é›†è„šæœ¬ä½¿ç”¨çš„æ¨¡å‹è·¯å¾„
```
/data/liyuefeng/offline-slate-rl/src/data_collection/offline_data_collection/models/
â”œâ”€â”€ expert/                          # è½¯é“¾æ¥åˆ° checkpoints/expert/
â”‚   â”œâ”€â”€ sac_gems/
â”‚   â”œâ”€â”€ sac_wknn/
â”‚   â”œâ”€â”€ slateq/
â”‚   â””â”€â”€ reinforce/
â””â”€â”€ medium/                          # è½¯é“¾æ¥åˆ° checkpoints/medium/
    â””â”€â”€ sac_gems/
```

## ğŸ”„ è·¯å¾„å…³ç³»è¯´æ˜

### è®­ç»ƒæ¨¡å‹ â†’ æ•°æ®æ”¶é›†çš„æµç¨‹

1. **è®­ç»ƒé˜¶æ®µ** (åœ¨æ—§é¡¹ç›®ä¸­)
   ```
   è®­ç»ƒè„šæœ¬è¿è¡Œ â†’ ä¿å­˜checkpointåˆ°:
   /data/liyuefeng/gems/gems_official/official_code/data/checkpoints/{env_name}/
   ```

2. **æ¨¡å‹è¿ç§»** (æ•´ç†åˆ°æ–°é¡¹ç›®)
   ```
   æ—§checkpoint â†’ å¤åˆ¶åˆ°æ–°é¡¹ç›®:
   /data/liyuefeng/offline-slate-rl/checkpoints/{quality}/{agent}/{env_name}/
   ```

3. **æ•°æ®æ”¶é›†å‡†å¤‡**
   ```
   åˆ›å»ºè½¯é“¾æ¥:
   /data/liyuefeng/offline-slate-rl/src/data_collection/offline_data_collection/models/{quality}/{agent}/
   â†’ æŒ‡å‘ checkpoints/{quality}/{agent}/
   ```

4. **æ•°æ®æ”¶é›†è¿è¡Œ**
   ```
   collect_data.py è¯»å–æ¨¡å‹:
   models/{quality}/{agent}/{env_name}/model.ckpt

   æ”¶é›†æ•°æ®ä¿å­˜åˆ°:
   /data/liyuefeng/offline-slate-rl/datasets/offline_datasets/{env_name}_{quality}/
   ```

## ğŸ“ è®­ç»ƒ50kæ­¥æ¨¡å‹åçš„æ“ä½œæµç¨‹

### åœºæ™¯ï¼šè®­ç»ƒä¸€ä¸ª50kæ­¥çš„mediumæ¨¡å‹

1. **ä¿®æ”¹è®­ç»ƒä»£ç ** (åœ¨æ—§é¡¹ç›®ä¸­)
   ```python
   # åœ¨ train_agent.py ä¸­æ·»åŠ ä¸­é—´checkpointä¿å­˜
   ckpt_medium = ModelCheckpoint(
       dirpath=ckpt_dir,
       filename=ckpt_name + "_step50000",
       every_n_train_steps=50000,
       save_top_k=-1
   )
   ```

2. **è¿è¡Œè®­ç»ƒ** (åœ¨æ—§é¡¹ç›®ä¸­)
   ```bash
   cd /data/liyuefeng/gems/gems_official/official_code
   python train_agent.py --agent=SAC --ranker=GeMS --env_name=topics \
       --ranker_dataset=diffuse_topdown --max_steps=50000 ...
   ```

   è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹ä¿å­˜åœ¨:
   ```
   /data/liyuefeng/gems/gems_official/official_code/data/checkpoints/diffuse_topdown/
   â””â”€â”€ SAC+GeMS_..._step50000.ckpt
   ```

3. **è¿ç§»æ¨¡å‹åˆ°æ–°é¡¹ç›®**
   ```bash
   # å¤åˆ¶åˆ°æ–°é¡¹ç›®çš„mediumç›®å½•
   cp /data/liyuefeng/gems/gems_official/official_code/data/checkpoints/diffuse_topdown/SAC+GeMS_..._step50000.ckpt \
      /data/liyuefeng/offline-slate-rl/checkpoints/medium/sac_gems/diffuse_topdown/beta1.0_click0.5_step50k.ckpt
   ```

4. **æ›´æ–°æ•°æ®æ”¶é›†è„šæœ¬çš„model_loader.py**
   ```python
   # åœ¨ model_loader.py ä¸­æ·»åŠ  load_medium_models() å‡½æ•°
   def load_medium_models(self):
       """åŠ è½½mediumè´¨é‡çš„æ¨¡å‹ (50kæ­¥è®­ç»ƒ)"""
       models_dir = self.base_dir / "medium" / "sac_gems"
       # ... åŠ è½½é€»è¾‘
   ```

5. **è¿è¡Œæ•°æ®æ”¶é›†**
   ```bash
   cd /data/liyuefeng/offline-slate-rl/src/data_collection/offline_data_collection
   python scripts/collect_data.py \
       --env_name diffuse_topdown \
       --quality medium \
       --episodes 10000 \
       --output_dir /data/liyuefeng/offline-slate-rl/datasets/offline_datasets \
       --gpu 5
   ```

6. **æ•°æ®ä¿å­˜ä½ç½®**
   ```
   /data/liyuefeng/offline-slate-rl/datasets/offline_datasets/
   â”œâ”€â”€ diffuse_topdown_expert/      # expertæ•°æ® (å·²æœ‰)
   â”‚   â”œâ”€â”€ expert_data.pkl
   â”‚   â””â”€â”€ expert_data_d4rl.npz
   â””â”€â”€ diffuse_topdown_medium/      # mediumæ•°æ® (æ–°æ”¶é›†)
       â”œâ”€â”€ medium_data.pkl
       â””â”€â”€ medium_data_d4rl.npz
   ```

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œ
1. âœ… åˆ›å»ºæ–°çš„checkpointsç›®å½•ç»“æ„
2. âœ… è¿ç§»æ‰€æœ‰expertæ¨¡å‹åˆ°æ–°ç»“æ„
3. âœ… æ›´æ–°æ•°æ®æ”¶é›†è„šæœ¬ä»¥æ”¯æŒæ–°è·¯å¾„
4. â³ ç­‰å¾…å½“å‰focused expertæ•°æ®æ”¶é›†å®Œæˆ

### åç»­ä»»åŠ¡
5. â¸ï¸ ä¿®æ”¹è®­ç»ƒä»£ç æ”¯æŒ50kæ­¥checkpointä¿å­˜
6. â¸ï¸ è®­ç»ƒ6ä¸ªç¯å¢ƒçš„mediumæ¨¡å‹ (50kæ­¥)
7. â¸ï¸ æ”¶é›†mediumè´¨é‡æ•°æ®
8. â¸ï¸ éªŒè¯expertå’Œmediumæ•°æ®è´¨é‡

## ğŸ“Š æ¨¡å‹æ€§èƒ½å¯¹æ¯” (ç”¨äºé€‰æ‹©æœ€ä½³æ¨¡å‹)

### SAC+GeMS (Final Episode Reward)
| Environment | beta0.5_click0.2 | beta1.0_click0.5 | é€‰æ‹© |
|-------------|------------------|------------------|------|
| diffuse_divpen | 272 | 175 | beta0.5 âœ“ |
| diffuse_mix | 205 | 258 | beta1.0 âœ“ |
| diffuse_topdown | 348 | 240 | beta0.5 âœ“ |
| focused_divpen | 212 | 208 | ç›¸è¿‘ |
| focused_mix | 237 | 68 | beta0.5 âœ“ |
| focused_topdown | 357 | 310 | beta0.5 âœ“ |

**æ³¨æ„**: ç›®å‰æ•°æ®æ”¶é›†ä½¿ç”¨çš„æ˜¯beta1.0æ¨¡å‹ï¼Œä½†ä»æ€§èƒ½æ¥çœ‹beta0.5åœ¨å¤šæ•°ç¯å¢ƒä¸­è¡¨ç°æ›´å¥½ã€‚
å»ºè®®åç»­æ”¶é›†æ•°æ®æ—¶ä½¿ç”¨æ€§èƒ½æœ€å¥½çš„æ¨¡å‹ã€‚

### Baselineæ€§èƒ½ (Focusedç¯å¢ƒ)
| Agent | focused_topdown | focused_mix | focused_divpen |
|-------|-----------------|-------------|----------------|
| SAC+GeMS (beta1.0) | 310 | 68 | 208 |
| SAC+WkNN | 68 | 48 | 30 |
| SlateQ | 190 | 230 | 41 |

**è§‚å¯Ÿ**: SAC+GeMSåœ¨å¤§å¤šæ•°ç¯å¢ƒä¸­è¡¨ç°æœ€å¥½ï¼Œä½†SlateQåœ¨focused_mixä¸Šè¡¨ç°å‡ºè‰²ã€‚
